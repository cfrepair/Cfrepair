<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CFREPAIR - Sistema de Taller</title>
    
    <!-- 1. ESTILOS Y LIBRER√çAS (CDN Globales y Estables) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React y ReactDOM (UMD para m√°xima compatibilidad) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- HTML2Canvas para recibos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Estilos Base */
        body { 
            background-color: #f3f4f6; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* Patr√≥n del Recibo */
        .receipt-paper { 
            background-color: #fff;
            background-image: radial-gradient(#d1d5db 1px, transparent 1px); 
            background-size: 20px 20px; 
            border-bottom: 2px dashed #ccc;
        }

        /* Animaciones */
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Pantalla de Carga */
        #loader { 
            position: fixed; inset: 0; background: white; z-index: 9999; 
            display: flex; justify-content: center; align-items: center; flex-direction: column; 
        }
        .spinner { 
            width: 40px; height: 40px; border: 4px solid #f3f3f3; 
            border-top: 4px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Ocultar Scrollbars feos */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estilos de Impresi√≥n */
        @media print { 
            .no-print { display: none !important; } 
            .print-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000; }
            .printable-area { box-shadow: none !important; margin: 0 !important; width: 100% !important; }
        }
    </style>
</head>
<body>

    <!-- LOADER INICIAL -->
    <div id="loader">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600 font-bold text-sm">Cargando Sistema...</p>
        <button onclick="localStorage.clear(); window.location.reload()" class="mt-8 text-xs text-red-500 underline">
            ¬øSe qued√≥ pegado? Toca aqu√≠ para reiniciar
        </button>
    </div>

    <!-- ROOT DE REACT -->
    <div id="root"></div>

    <!-- SCRIPT PRINCIPAL -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        const { 
            Smartphone, PlusCircle, ClipboardList, CheckCircle, User, Settings, Trash2, 
            Edit, Save, X, Printer, Wrench, DollarSign, Contact, AlertTriangle, Share2, 
            Image: ImageIcon, Camera, Box, Tag, FileText, CreditCard, RefreshCw, 
            ChevronDown, Download, Search
        } = lucide;

        // --- 1. BASE DE DATOS COMPLET√çSIMA (2025) ---
        const PHONE_DB = {
            "Samsung": [
                "Galaxy S24 Ultra", "Galaxy S24+", "Galaxy S24", "Galaxy S23 FE", "Galaxy S23 Ultra",
                "Galaxy A55 5G", "Galaxy A35 5G", "Galaxy A25 5G", "Galaxy A15", "Galaxy A05s", "Galaxy A05",
                "Galaxy A54", "Galaxy A34", "Galaxy A24", "Galaxy A14", "Galaxy A04s", "Galaxy A04e",
                "Galaxy M55", "Galaxy M34", "Galaxy M14", "Galaxy F15",
                "Galaxy J7 Prime", "Galaxy J5 Prime", "Galaxy J2 Prime", "Galaxy Grand Prime"
            ],
            "Infinix": [
                "Hot 50 Pro+", "Hot 50 Pro", "Hot 50i", "Hot 50",
                "Hot 40 Pro", "Hot 40i", "Hot 40", "Hot 30 Play", "Hot 30i", "Hot 30",
                "Note 40 Pro+ 5G", "Note 40 Pro", "Note 40", "Note 30 VIP", "Note 30 Pro",
                "Smart 9", "Smart 8 Pro", "Smart 8", "Smart 7 HD",
                "GT 20 Pro", "GT 10 Pro", "Zero 40", "Zero 30 5G"
            ],
            "Tecno": [
                "Spark 30 Pro", "Spark 30C", "Spark 30",
                "Spark 20 Pro+", "Spark 20 Pro", "Spark 20C", "Spark 20", "Spark Go 2024",
                "Pova 6 Pro 5G", "Pova 6 Neo", "Pova 6", "Pova 5 Pro", "Pova 5",
                "Camon 30 Premier", "Camon 30 Pro", "Camon 30", "Camon 20 Premier",
                "Pop 9", "Pop 8", "Pop 7"
            ],
            "Xiaomi": [
                "Redmi Note 13 Pro+", "Redmi Note 13 Pro", "Redmi Note 13",
                "Redmi Note 12S", "Redmi Note 12", "Redmi 14C", "Redmi 13C", "Redmi 12", "Redmi 10C", "Redmi 9A",
                "POCO F6", "POCO X6 Pro", "POCO X6", "POCO M6 Pro", "POCO C65"
            ],
            "Motorola": [
                "Edge 50 Ultra", "Edge 50 Pro", "Edge 50 Fusion",
                "Moto G85", "Moto G84", "Moto G54", "Moto G24 Power", "Moto G14", "Moto G04",
                "Moto E14", "Moto E13", "Moto E22"
            ],
            "Apple": [
                "iPhone 16 Pro Max", "iPhone 16", "iPhone 15 Pro Max", "iPhone 15",
                "iPhone 14 Pro Max", "iPhone 14", "iPhone 13", "iPhone 11", "iPhone XR", "iPhone 8 Plus"
            ],
            "Honor": ["Magic 6 Lite", "Honor 200", "Honor 90", "Honor X8b", "Honor X7b", "Honor X6b"],
            "Realme": ["Realme 12 Pro+", "Realme C67", "Realme C55", "Realme C53", "Realme C51"],
            "ZTE": ["Blade V50", "Blade A72", "Blade A52"],
            "Otro": []
        };

        const COMMON_ISSUES = ["Pantalla Rota", "Bater√≠a", "Pin de Carga", "Software", "No Enciende", "Mojado", "C√°mara", "Altavoz", "Mantenimiento"];
        const DEFAULT_TERMS = "1. Diagn√≥stico en 24-48 horas.\n2. No nos hacemos responsables por p√©rdida de informaci√≥n.\n3. Equipos mojados no tienen garant√≠a.\n4. Pasados 30 d√≠as el equipo pasa a reciclaje.";

        // --- HELPERS (Seguridad Anti-Crash) ---
        const safeId = (id) => String(id || Math.random().toString().slice(2,8));
        const safeFloat = (val) => {
            if(typeof val === 'string') val = val.replace(',', '.');
            const n = parseFloat(val);
            return isNaN(n) ? 0 : n;
        };
        const formatBs = (val) => safeFloat(val).toLocaleString('es-VE', {minimumFractionDigits:2, maximumFractionDigits:2});
        const formatUsd = (val) => safeFloat(val).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});

        // Compresor de Im√°genes (CRUCIAL PARA EVITAR PANTALLA BLANCA)
        const compressImage = (file, maxWidth = 300) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Calidad media (0.6) para ahorrar espacio en localStorage
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        };

        // --- COMPONENTE: INPUT INTELIGENTE ---
        const SmartInput = ({ label, value, onChange, rate, currency }) => {
            const [focused, setFocused] = useState(false);
            const display = focused ? value : (value == 0 ? '' : (currency === 'BS' ? formatBs(value) : value));
            
            let refText = '';
            if(rate > 0 && value > 0) {
                const val = safeFloat(value);
                const r = safeFloat(rate);
                if(currency === 'USD') {
                   refText = `Ref: Bs ${formatBs(val * r)}`;
                } else {
                   refText = `Ref: $ ${formatUsd(val / r)}`;
                }
            }

            return (
                <div className="flex flex-col">
                    <label className="text-[10px] font-bold text-gray-500 uppercase mb-1">{label}</label>
                    <div className="relative">
                        <span className={`absolute left-3 top-1/2 -translate-y-1/2 font-bold ${currency==='BS'?'text-blue-600':'text-green-600'}`}>
                            {currency==='BS'?'Bs':'$'}
                        </span>
                        <input 
                            type={focused ? "number" : "text"} 
                            className="w-full pl-9 p-2 border border-gray-300 rounded-lg font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                            value={display}
                            onChange={e => onChange(e.target.value)}
                            onFocus={() => setFocused(true)}
                            onBlur={() => setFocused(false)}
                            placeholder="0.00"
                        />
                    </div>
                    {refText && <div className="text-right text-[10px] font-bold text-blue-600 mt-1">{refText}</div>}
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [tab, setTab] = useState('dashboard');
            const [tickets, setTickets] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [selTicket, setSelTicket] = useState(null);
            
            // UI State
            const [showReceipt, setShowReceipt] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [logo, setLogo] = useState(null);
            const [rate, setRate] = useState(0);
            const [terms, setTerms] = useState(DEFAULT_TERMS);
            const [genImg, setGenImg] = useState(null);
            
            // Forms
            const [form, setForm] = useState({ customer: '', phone: '', desc: '', cost: '', deposit: '', currency: 'USD', images: [], customerPhone: '' });
            const [brand, setBrand] = useState("");
            const [model, setModel] = useState("");
            const [isManual, setIsManual] = useState(false);
            const [listFilter, setListFilter] = useState('Todos');
            const [searchTerm, setSearchTerm] = useState('');
            const [newItem, setNewItem] = useState({ name: '', stock: '', cost: '', price: '' });

            // --- INICIO ---
            useEffect(() => {
                document.getElementById('loader').style.display = 'none';
                
                // Carga Segura con Try-Catch
                try {
                    const t = localStorage.getItem('cf_tickets'); 
                    if(t) {
                        // Sanitizamos IDs al cargar por si acaso
                        const d = JSON.parse(t).map(x => ({
                            ...x, 
                            id: String(x.id), 
                            cost: parseFloat(x.cost||0), 
                            deposit: parseFloat(x.deposit||0)
                        }));
                        setTickets(d);
                    }
                    const i = localStorage.getItem('cf_inv'); if(i) setInventory(JSON.parse(i));
                    const l = localStorage.getItem('cf_logo'); if(l) setLogo(l);
                    const r = localStorage.getItem('cf_rate'); if(r) setRate(parseFloat(r));
                    const tr = localStorage.getItem('cf_terms'); if(tr) setTerms(tr);
                } catch(e) { 
                    console.error("Error carga local", e); 
                }

                // Activar iconos
                if(window.lucide) window.lucide.createIcons();
            }, []);

            // Refrescar iconos en cada cambio de render
            useEffect(() => { if(window.lucide) window.lucide.createIcons(); });

            // --- GUARDADO SEGURO ---
            const saveLocal = (key, data) => {
                try { 
                    localStorage.setItem(key, JSON.stringify(data)); 
                    return true; 
                } catch(e) { 
                    alert("‚ö†Ô∏è ¬°MEMORIA LLENA! Tu navegador no permite guardar m√°s datos. Intenta borrar fotos antiguas o el historial."); 
                    return false; 
                }
            };

            // GUARDAR TICKET
            const handleSaveTicket = (e) => {
                e.preventDefault();
                if(!form.customer) return alert("Falta el nombre del cliente");

                const id = Date.now().toString();
                const finalPhone = isManual ? form.phone : `${brand} ${model}`;
                
                const newT = { 
                    ...form, 
                    id, 
                    phone: finalPhone || "Equipo Gen√©rico",
                    status: 'Recibido', 
                    date: new Date().toLocaleDateString('es-VE'), 
                    ts: Date.now(),
                    rateAtCreation: rate,
                    cost: parseFloat(form.cost||0), 
                    deposit: parseFloat(form.deposit||0)
                };
                
                const next = [newT, ...tickets];
                
                if(saveLocal('cf_tickets', next)) {
                    setTickets(next);
                    setSelTicket(newT);
                    setShowReceipt(true); // Abrir recibo de una vez
                    
                    // Limpiar todo
                    setForm({ customer: '', phone: '', desc: '', cost: 0, deposit: 0, currency: 'USD', images: [], customerPhone: '', imei: '', passcode: '' });
                    setBrand(""); setModel(""); setIsManual(false);
                }
            };

            // --- MANEJO DE FOTOS (COMPRIMIDO) ---
            const handlePhoto = async (e) => {
                const f = e.target.files[0];
                if(!f) return;
                
                try {
                    const url = await compressImage(f, 400); // Max 400px
                    if(form.images.length < 3) {
                        setForm(p => ({...p, images: [...p.images, url]}));
                    } else {
                        alert("M√°ximo 3 fotos por ticket.");
                    }
                } catch(err) {
                    alert("Error al procesar la imagen.");
                }
            };

            const handleLogo = async (e) => {
                const f = e.target.files[0];
                if(!f) return;
                try {
                    const url = await compressImage(f, 200); // Logo peque√±o
                    setLogo(url);
                    saveLocal('cf_logo', url);
                } catch(err) { alert("Error al procesar logo."); }
            };

            const removePhoto = (idx) => setForm(p => ({...p, images: p.images.filter((_, i) => i !== idx)}));

            // --- CRUD INVENTARIO & OTROS ---
            const handleSaveItem = (e) => { e.preventDefault(); const id=Date.now().toString(); const next=[...inventory, {...newItem, id}]; if(saveLocal('cf_inv', next)) { setInventory(next); setNewItem({name:'',stock:'',cost:'',price:''}); } };
            const deleteItem = (id, type) => { if(!confirm('¬øEliminar?')) return; if(type==='ticket'){ const next = tickets.filter(x=>x.id!==id); saveLocal('cf_tickets', next); setTickets(next); setShowModal(false); } else { const next = inventory.filter(x=>x.id!==id); saveLocal('cf_inv', next); setInventory(next); } };
            const updateStock = (id, d) => { const next = inventory.map(x=>x.id===id?{...x, stock: Math.max(0, parseInt(x.stock)+d)}:x); saveLocal('cf_inv', next); setInventory(next); };
            const updateStatus = (id, s) => { const next = tickets.map(x=>x.id===id?{...x, status:s}:x); saveLocal('cf_tickets', next); setTickets(next); if(selTicket) setSelTicket({...selTicket, status:s}); };
            
            const handleImportContact = async () => {
                if(!('contacts' in navigator && 'ContactsManager' in window)) {
                    alert("Tu celular no soporta importar contactos. Escr√≠belo manual.");
                    return;
                }
                try {
                    const c = await navigator.contacts.select(['name', 'tel'], { multiple: false });
                    if (c.length) setForm(p => ({ ...p, customer: c[0].name[0], customerPhone: c[0].tel[0] }));
                } catch (e) {}
            };

            // --- WHATSAPP ---
            const openWA = (t, isReceipt) => {
                if(!t) return;
                let ph = (t.customerPhone||'').replace(/\D/g,'');
                if(ph.startsWith('04')) ph = '58'+ph.substring(1);
                
                const isBs = t.currency === 'BS';
                const sym = isBs ? 'Bs' : '$';
                const bal = (safeFloat(t.cost) - safeFloat(t.deposit)).toFixed(2);
                const r = t.rateAtCreation || rate;
                
                let msg = '';
                if(isReceipt) {
                    let refTxt = '';
                    if(r > 0) refTxt = isBs ? `(Ref $${formatUsd(bal/r)})` : `(Ref Bs${formatBs(bal*r)})`;
                    msg = `üßæ *RECIBO CFREPAIR*\nOrden: #${safeId(t.id).slice(-4)}\nCliente: ${t.customer}\nEquipo: ${t.phone}\n\nüíµ Total: ${sym}${t.cost}\n‚úÖ Abono: ${sym}${t.deposit}\n‚ùó *Resta: ${sym}${bal}* ${refTxt}`;
                } else {
                    msg = `Hola ${t.customer}, novedad con tu equipo ${t.phone}...`;
                }
                window.open(`https://api.whatsapp.com/send?phone=${ph}&text=${encodeURIComponent(msg)}`);
            };

            // --- GENERAR IMAGEN ---
            const handleGenImage = async () => {
                const el = document.getElementById('receipt-content');
                if(el) {
                    try {
                        // Ocultar botones temporalmente
                        const btns = document.querySelectorAll('.no-print');
                        btns.forEach(b => b.style.display = 'none');
                        
                        await new Promise(r => setTimeout(r, 200)); // Esperar render
                        const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#fff', logging: false });
                        
                        // Mostrar botones
                        btns.forEach(b => b.style.display = 'flex');
                        setGenImg(canvas.toDataURL('image/png'));
                    } catch(e) { alert("Error al crear imagen: " + e.message); }
                }
            };

            // --- COMPONENTE VISTA PREVIA IMAGEN (Con Bot√≥n Compartir) ---
            const ImagePreview = () => (
                <div className="fixed inset-0 z-[80] bg-black/95 flex flex-col items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-lg p-3 max-w-sm w-full">
                        <div className="flex justify-between items-center mb-2 px-1">
                            <h3 className="font-bold text-gray-800">Imagen Generada</h3>
                            <button onClick={()=>setGenImg(null)}><i data-lucide="x" className="text-gray-500"></i></button>
                        </div>
                        <img src={genImg} className="w-full h-auto border rounded mb-3"/>
                        <button onClick={async()=>{
                            try {
                                const r = await fetch(genImg);
                                const b = await r.blob();
                                const f = new File([b], `Recibo_${selTicket.id}.png`, {type:'image/png'});
                                if(navigator.share) await navigator.share({files:[f], title:'Recibo'});
                                else {
                                    const a = document.createElement('a'); a.href=genImg; a.download="Recibo.png"; a.click();
                                }
                            } catch(e) { alert("Usa la opci√≥n Descargar"); }
                        }} className="w-full py-3 bg-green-600 text-white rounded-lg font-bold flex justify-center items-center gap-2 shadow"><i data-lucide="share-2"></i> Compartir / WhatsApp</button>
                    </div>
                </div>
            );

            // --- RENDER ---
            return (
                <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative pb-20">
                    
                    {/* Header */}
                    <div className="p-4 border-b sticky top-0 bg-white z-30 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-2">
                            {logo ? <img src={logo} className="h-8 object-contain"/> : <i data-lucide="wrench" className="text-blue-600"></i>}
                            <h1 className="font-black text-lg text-gray-800">CF<span className="text-blue-600">REPAIR</span></h1>
                        </div>
                        {rate > 0 && <span className="text-xs font-bold bg-green-100 text-green-800 px-2 py-1 rounded border border-green-200">Bs {formatBs(rate)}</span>}
                    </div>

                    <div className="p-4">
                        
                        {/* PANEL */}
                        {tab === 'dashboard' && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="grid grid-cols-2 gap-3">
                                    <div onClick={()=>{setListFilter('Recibidos'); setTab('list')}} className="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500 cursor-pointer shadow-sm"><p className="text-xs font-bold text-gray-500">PENDIENTES</p><p className="text-2xl font-bold text-gray-800">{tickets.filter(t => ['Recibido','En Revisi√≥n'].includes(t.status)).length}</p></div>
                                    <div onClick={()=>{setListFilter('En Reparaci√≥n'); setTab('list')}} className="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 cursor-pointer shadow-sm"><p className="text-xs font-bold text-gray-500">TALLER</p><p className="text-2xl font-bold text-gray-800">{tickets.filter(t => t.status === 'En Reparaci√≥n').length}</p></div>
                                    <div onClick={()=>{setListFilter('Listos'); setTab('list')}} className="bg-green-50 p-4 rounded-lg border-l-4 border-green-500 cursor-pointer shadow-sm"><p className="text-xs font-bold text-gray-500">LISTOS</p><p className="text-2xl font-bold text-gray-800">{tickets.filter(t => t.status === 'Listo').length}</p></div>
                                    <div onClick={()=>{setListFilter('Entregados'); setTab('list')}} className="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500 cursor-pointer shadow-sm"><p className="text-xs font-bold text-gray-500">ENTREGADOS</p><p className="text-2xl font-bold text-gray-800">{tickets.filter(t => t.status === 'Entregado').length}</p></div>
                                </div>
                                <button onClick={() => setTab('create')} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2 active:scale-95 transition-transform"><i data-lucide="plus-circle"></i> Nuevo Ingreso</button>
                            </div>
                        )}

                        {/* CREAR */}
                        {tab === 'create' && (
                            <form onSubmit={handleSaveTicket} className="space-y-4 animate-fade-in">
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-gray-500">CLIENTE</label><input required className="w-full p-2 border rounded" value={form.customer} onChange={e=>setForm({...form, customer:e.target.value})}/></div>
                                    <div><label className="text-xs font-bold text-gray-500">TEL√âFONO</label><div className="flex gap-1"><input id="phoneInput" type="tel" className="w-full p-2 border rounded" value={form.customerPhone} onChange={e=>setForm({...form, customerPhone:e.target.value})}/><button type="button" onClick={handleImportContact} className="bg-blue-100 p-2 rounded text-blue-600"><i data-lucide="contact"></i></button></div></div>
                                </div>
                                
                                <div className="bg-gray-50 p-3 rounded border space-y-2">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-[10px] font-bold">MARCA</label><select className="w-full p-2 bg-white border rounded text-sm" value={brand} onChange={e=>{setBrand(e.target.value); setIsManual(e.target.value==='Otro'); setModel(""); if(e.target.value==='Otro') setForm({...form, phone: ''});}}><option value="">Ver...</option>{Object.keys(PHONE_DB).map(k=><option key={k} value={k}>{k}</option>)}<option value="Otro">Otro</option></select></div>
                                        <div><label className="text-[10px] font-bold">MODELO</label>{isManual ? <input className="w-full p-2 bg-white border rounded text-sm" value={form.phone} placeholder="Escribe..." onChange={e=>setForm({...form, phone:e.target.value})}/> : <select className="w-full p-2 bg-white border rounded text-sm" disabled={!brand} value={model} onChange={e=>{setModel(e.target.value); setForm({...form, phone: `${brand} ${e.target.value}`})}}><option value="">Ver...</option>{brand && PHONE_DB[brand]?.map(m=><option key={m} value={m}>{m}</option>)}</select>}</div>
                                    </div>
                                    <textarea className="w-full p-2 border rounded text-sm h-20" placeholder="Falla..." value={form.desc} onChange={e=>setForm({...form, desc:e.target.value})}/>
                                    <div className="flex flex-wrap gap-1">{COMMON_ISSUES.map(i => <button type="button" key={i} onClick={()=>setForm(p=>({...p, desc: p.desc ? p.desc+', '+i : i}))} className="text-[10px] border px-2 py-1 rounded bg-white hover:bg-blue-50">{i}</button>)}</div>
                                </div>

                                <div className="border-t pt-3">
                                    <div className="flex gap-2 mb-2 bg-gray-100 p-1 rounded">
                                        <button type="button" onClick={()=>setForm({...form, currency:'USD'})} className={`flex-1 text-xs py-2 rounded font-bold ${form.currency==='USD'?'bg-white text-green-700 shadow':'text-gray-500'}`}>$ USD</button>
                                        <button type="button" onClick={()=>setForm({...form, currency:'BS'})} className={`flex-1 text-xs py-2 rounded font-bold ${form.currency==='BS'?'bg-white text-blue-700 shadow':'text-gray-500'}`}>Bs VES</button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <SmartInput label="Total" value={form.cost} onChange={v=>setForm({...form, cost:v})} rate={rate} currency={form.currency}/>
                                        <SmartInput label="Abono" value={form.deposit} onChange={v=>setForm({...form, deposit:v})} rate={rate} currency={form.currency}/>
                                    </div>
                                </div>

                                <div className="flex gap-2 overflow-x-auto py-2"><label className="flex-shrink-0 w-16 h-16 border-2 border-dashed rounded flex items-center justify-center bg-gray-50 cursor-pointer text-blue-500"><i data-lucide="camera"></i><input type="file" accept="image/*" className="hidden" onChange={handlePhoto}/></label>{form.images.map((src, idx) => (<div key={idx} className="relative w-16 h-16 flex-shrink-0"><img src={src} className="w-full h-full object-cover rounded border"/><button type="button" onClick={()=>removePhoto(idx)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 w-5 h-5 flex items-center justify-center text-[10px]">x</button></div>))}</div>
                                <button className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow text-lg active:scale-95 transition-transform">REGISTRAR</button>
                            </form>
                        )}

                        {/* LIST */}
                        {tab === 'list' && (
                            <div className="space-y-3 animate-fade-in">
                                <div className="sticky top-0 bg-f3f4f6 z-10 pb-2 space-y-2">
                                    <input className="w-full p-2 border rounded shadow-sm" placeholder="Buscar..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/>
                                    <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">{['Todos', 'Recibidos', 'En Reparaci√≥n', 'Listos', 'Entregados'].map(f => (<button key={f} onClick={()=>setListFilter(f)} className={`px-3 py-1 rounded-full text-xs font-bold border whitespace-nowrap ${listFilter===f?'bg-blue-600 text-white':'bg-white text-gray-600'}`}>{f}</button>))}</div>
                                </div>
                                {tickets.filter(t => {
                                    const matchSearch = t.customer.toLowerCase().includes(searchTerm.toLowerCase()) || (t.phone && t.phone.toLowerCase().includes(searchTerm.toLowerCase()));
                                    let matchFilter = true;
                                    if(listFilter === 'Recibidos') matchFilter = ['Recibido','En Revisi√≥n'].includes(t.status);
                                    else if(listFilter !== 'Todos') matchFilter = t.status === listFilter.replace(/s$/,'') || t.status === listFilter; 
                                    return matchSearch && matchFilter;
                                }).map(t => (
                                    <div key={t.id} onClick={()=>{setSelTicket(t); setShowModal(true)}} className="bg-white p-3 rounded shadow-sm border flex justify-between items-center cursor-pointer active:bg-gray-50">
                                        <div><div className="font-bold text-sm">{t.customer} <span className="text-[10px] text-gray-400">#{safeId(t.id).slice(-4)}</span></div><div className="text-xs text-gray-500">{t.phone}</div></div><span className={`text-[10px] px-2 py-1 rounded font-bold ${t.status==='Listo'?'bg-green-100 text-green-800':'bg-gray-100'}`}>{t.status}</span>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* INVENTORY */}
                        {tab === 'inventory' && (
                            <div className="space-y-4 animate-fade-in"><div className="bg-white p-4 rounded shadow"><h3 className="font-bold mb-2 text-sm">Nuevo Repuesto</h3><div className="flex flex-col gap-2"><input className="border p-2 rounded text-sm" placeholder="Nombre" value={newItem.name} onChange={e=>setNewItem({...newItem, name: e.target.value})}/><div className="flex gap-2"><input type="number" className="border p-2 rounded w-1/4 text-sm" placeholder="#" value={newItem.stock} onChange={e=>setNewItem({...newItem, stock: e.target.value})}/><div className="flex-1"><SmartInput label="Costo" value={newItem.cost} onChange={v=>setNewItem({...newItem, cost:v})} rate={rate} currency="USD"/></div><div className="flex-1"><SmartInput label="Venta" value={newItem.price} onChange={v=>setNewItem({...newItem, price:v})} rate={rate} currency="USD"/></div></div><button onClick={handleSaveItem} className="bg-green-600 text-white p-2 rounded font-bold text-sm">Guardar</button></div></div><div className="grid gap-2">{inventory.map(i => (<div key={i.id} className="bg-white p-3 rounded border shadow-sm flex justify-between items-center"><div><div className="font-bold text-sm">{i.name}</div><div className="text-xs text-gray-500">Stock: {i.stock} | Venta: ${i.price}</div></div><div className="flex items-center gap-2"><button onClick={()=>updateStock(i.id, -1)} className="bg-gray-200 w-8 h-8 flex items-center justify-center rounded font-bold">-</button><span className="text-sm font-bold">{i.stock}</span><button onClick={()=>updateStock(i.id, 1)} className="bg-gray-200 w-8 h-8 flex items-center justify-center rounded font-bold">+</button><button onClick={()=>deleteInvItem(i.id)} className="text-red-500 ml-2"><i data-lucide="trash-2"></i></button></div></div>))}</div></div>
                        )}
                        {tab === 'settings' && (
                            <div className="space-y-4 animate-fade-in"><div className="bg-white p-4 rounded shadow"><h3 className="font-bold mb-2">Tasa Bs/$</h3><div className="flex gap-2"><input type="number" className="border p-2 rounded w-full font-bold text-lg" value={rate} onChange={e=>setRate(e.target.value)}/><button onClick={()=>{saveLocal('cf_rate', rate); alert('Guardado')}} className="bg-blue-600 text-white px-4 rounded font-bold">OK</button></div></div><div className="bg-white p-4 rounded shadow flex justify-between items-center"><div><h3 className="font-bold">Logo</h3><p className="text-xs text-gray-500">Toca para cambiar</p></div><label className="w-16 h-16 border-2 border-dashed rounded flex items-center justify-center cursor-pointer">{logo ? <img src={logo} className="w-full h-full object-contain"/> : <i data-lucide="image" className="text-gray-300"></i>}<input type="file" accept="image/*" className="hidden" onChange={handleLogo}/></label></div><div className="bg-white p-4 rounded shadow"><h3 className="font-bold mb-2">T√©rminos</h3><textarea className="w-full border p-2 rounded h-24 text-xs" value={terms} onChange={e=>setTerms(e.target.value)}/><button onClick={()=>{saveLocal('cf_terms', terms); alert('Guardado')}} className="w-full mt-2 bg-gray-800 text-white py-2 rounded text-xs font-bold">Guardar</button></div></div>
                        )}
                    </div>

                    {/* MODALES */}
                    
                    {/* DETALLES */}
                    {showModal && selTicket && !showReceipt && (
                         <div className="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4 animate-fade-in">
                             <div className="bg-white rounded-xl w-full max-w-md p-5 space-y-4 shadow-2xl">
                                <div className="flex justify-between items-center border-b pb-2"><h3 className="font-bold text-lg">Orden #{safeId(selTicket.id).slice(-5)}</h3><button onClick={()=>setShowModal(false)}><i data-lucide="x"></i></button></div>
                                <div><p className="text-xs font-bold text-gray-500">CLIENTE</p><p className="text-lg">{selTicket.customer}</p></div>
                                <div><p className="text-xs font-bold text-gray-500">EQUIPO</p><p className="font-bold">{selTicket.phone}</p><p className="text-sm italic text-gray-600">{selTicket.desc}</p></div>
                                {selTicket.images?.length > 0 && (<div><p className="text-xs font-bold text-gray-500 mb-2">EVIDENCIA</p><div className="flex gap-2 overflow-x-auto pb-2">{selTicket.images.map((img,i)=><img key={i} src={img} className="w-20 h-20 rounded border object-cover"/>)}</div></div>)}
                                <div className="grid grid-cols-3 gap-2 mt-4">{['En Reparaci√≥n', 'Listo', 'Entregado'].map(s => (<button key={s} onClick={()=>{ updateStatus(selTicket.id, s); }} className={`text-[10px] py-2 rounded border font-bold transition-colors ${selTicket.status===s?'bg-blue-600 text-white border-blue-600':'bg-gray-50 text-gray-600 hover:bg-gray-100'}`}>{s}</button>))}</div>
                                <div className="flex gap-2 border-t pt-4">
                                    <button onClick={()=>{deleteTicket(selTicket.id)}} className="p-3 border rounded-lg text-red-500 hover:bg-red-50"><i data-lucide="trash-2"></i></button>
                                    <button onClick={()=>{setShowModal(false); setShowReceipt(true)}} className="flex-1 bg-gray-900 text-white rounded-lg font-bold flex items-center justify-center gap-2"><i data-lucide="printer" size={18}></i> Ver Recibo</button>
                                </div>
                             </div>
                         </div>
                    )}

                    {/* RECIBO */}
                    {showReceipt && selTicket && (() => {
                        const isBs = selTicket.currency === 'BS';
                        const symbol = isBs ? 'Bs.' : '$';
                        const total = safeFloat(selTicket.cost);
                        const abono = safeFloat(selTicket.deposit);
                        const resta = total - abono;
                        const r = selTicket.rateAtCreation || rate;
                        let refText = null;
                        if(r > 0) refText = isBs ? `Ref: $${formatUsd(resta / r)}` : `Ref: Bs.${formatBs(resta * r)}`;

                        return (
                            <div className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 overflow-y-auto">
                                <div className="bg-white w-full max-w-sm rounded-lg overflow-hidden shadow-2xl">
                                    <div id="receipt-content" className="p-6 bg-white text-black receipt-paper text-xs font-mono printable-area">
                                        <div className="text-center border-b-2 border-dashed pb-3 mb-3">
                                            {logo && <img src={logo} className="h-14 mx-auto mb-2 object-contain"/>}
                                            <h2 className="text-xl font-black">CFREPAIR</h2>
                                            <p>{selTicket.date} - #{safeId(selTicket.id).slice(-4)}</p>
                                        </div>
                                        <div className="space-y-1 mb-3">
                                            <div className="flex justify-between"><span>Cliente:</span> <strong>{selTicket.customer}</strong></div>
                                            <div className="flex justify-between"><span>Equipo:</span> <strong>{selTicket.phone}</strong></div>
                                            <div className="pt-1 border-t border-dotted mt-1"><span>Falla:</span> <p>{selTicket.desc}</p></div>
                                        </div>
                                        <div className="border-y-2 border-dashed py-2 my-2 space-y-1">
                                            <div className="flex justify-between"><span>Total:</span> <strong>{symbol} {isBs?formatBs(total):formatUsd(total)}</strong></div>
                                            <div className="flex justify-between"><span>Abono:</span> <span>{symbol} {isBs?formatBs(abono):formatUsd(abono)}</span></div>
                                            <div className="flex justify-between text-base font-black mt-1 border-t pt-1"><span>RESTA:</span> <span>{symbol} {isBs?formatBs(resta):formatUsd(resta)}</span></div>
                                            {refText && <div className="text-right text-[10px] font-bold text-gray-600">{refText}</div>}
                                        </div>
                                        <p className="text-[9px] text-justify text-gray-500 mt-2 whitespace-pre-wrap">{terms}</p>
                                    </div>
                                    <div className="bg-gray-100 p-3 flex flex-col gap-2 no-print">
                                        <button onClick={handleGenImage} className="w-full py-3 bg-purple-600 text-white rounded font-bold flex justify-center items-center gap-2"><i data-lucide="image"></i> Generar Imagen</button>
                                        <button onClick={()=>openWA(selTicket, true)} className="w-full py-3 bg-green-600 text-white rounded font-bold flex justify-center items-center gap-2"><i data-lucide="share-2"></i> Enviar WhatsApp</button>
                                        <button onClick={()=>setShowReceipt(false)} className="w-full py-3 bg-gray-300 text-gray-800 rounded font-bold">Cerrar</button>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {/* IMAGEN GENERADA */}
                    {genImg && <ImagePreviewModal imageUrl={genImg} onClose={()=>setGenImg(null)} fileName={`Recibo_${safeId(selTicket.id).slice(-4)}.png`} />}

                    {/* BOTTOM NAV */}
                    <div className="fixed bottom-0 w-full bg-white border-t flex justify-around p-2 z-40 pb-4 shadow-lg">
                        {[{id:'dashboard',l:'Panel',i:'clipboard-list'}, {id:'create',l:'Ingreso',i:'plus-circle'}, {id:'list',l:'Lista',i:'smartphone'}, {id:'inventory',l:'Inv.',i:'box'}, {id:'settings',l:'Ajustes',i:'settings'}].map(b => (
                            <button key={b.id} onClick={()=>setTab(b.id)} className={`flex flex-col items-center p-1 transition-colors ${tab===b.id?'text-blue-600':'text-gray-400'}`}>
                                <i data-lucide={b.i} className="w-6 h-6"></i>
                                <span className="text-[10px] font-bold mt-1">{b.l}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>


